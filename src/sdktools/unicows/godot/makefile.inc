!INCLUDE $(NTMAKEENV)\makefile.plt

FULLTARGET=$(_OBJ_DIR)\$(TARGET_DIRECTORY)

# this file is a database created by sortpp.exe after it scans the c-preprocessed  
# version of headers.h.  genthnk.exe consumes it to generate thunks.
PPMFILE=$(FULLTARGET)\winincs.ppm

# list of APIs to actually thunk.  
APILIST=api.lst

# the script to build autogenerated source files for getthnk
BLDFILES=.\bldfiles.pl

# These are the files that are to be generated by BLDFILES
APILISTW=$(FULLTARGET)\unicows.lst
FIXAW=$(FULLTARGET)\fixaw.h
DEFFILE=unicows.def

# name of generated .c files
GENFILE=Win9xU.c
FAILFILE=..\Failure.c
FAILFILEHEADER=..\Failure.h

CXX_COMPILER_NAME=$(CXX_COMPILER_NAME) -noHRESULT -DIN=__in -DOUT=__out
CPP_FLAGS=$(WOW64_CPP_FLAGS) -DSORTPP_PASS -DGUID_DEFINED

$(FULLTARGET)\winincs.pp: winincs.cpp headers.h
     -mkdir $(FULLTARGET)
     $(CXX_COMPILER_NAME) $(WOW64_CPP_FLAGS) /C @<<$(FULLTARGET)\cl.rsp /E /FC winincs.cpp >$(FULLTARGET)\winincs2.pp
$(CXX_COMPILER_FLAGS: =
)
<<NOKEEP
     idlclean.exe $(FULLTARGET)\winincs2.pp $(FULLTARGET)\winincs2.cpp
     $(CXX_COMPILER_NAME) @<<cl.rsp /E /FC $(FULLTARGET)\winincs2.cpp >$(FULLTARGET)\winincs.pp
$(CXX_COMPILER_FLAGS: =
)
<<NOKEEP

$(APILISTW) $(FIXAW) $(DEFFILE) : $(APILIST) $(BLDFILES)
     perl.exe $(BLDFILES) $**

$(PPMFILE): $(FULLTARGET)\winincs.pp
    sortpp.exe $(SORTPP_FLAGS) -m$(PPMFILE) $(FULLTARGET)\winincs.pp

$(GENFILE): $(PPMFILE) unicows.tpl $(APILISTW)
    genthnk.exe -m$(PPMFILE) -tunicows.tpl -c$(GENFILE):UnicodeWrappers -E$(APILISTW)

$(FAILFILE): $(PPMFILE) failure.tpl $(APILISTW)
    genthnk.exe -m$(PPMFILE) -tfailure.tpl -c$(FAILFILE):FailWrappers -E$(APILISTW)

$(FAILFILEHEADER): $(PPMFILE) failure.tpl $(APILISTW)
    genthnk.exe -m$(PPMFILE) -tfailure.tpl -c$(FAILFILEHEADER):FailWrapperHeaders -E$(APILISTW)

thunks: $(PPMFILE) $(FIXAW) $(GENFILE) $(FAILFILE) $(FAILFILEHEADER)

cleanfiles:
    -del $(FAILFILEHEADER)
    -del $(FAILFILE)
    -del $(GENFILE)
    -del $(PPMFILE)
    -del $(APILISTW)
    -del $(FIXAW)
    -del $(DEFFILE)

clean: cleanfiles thunks

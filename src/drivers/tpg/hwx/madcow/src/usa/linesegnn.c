#include <limits.h>
#include "common.h"

// generated by trntrex from 3560
// layer 0
static const int cInput = 19;
// layer 1
static const int cHidden = 8;
static const int rgWeightHidden[8*19] = {
	// rgWeightHidden+0*19
	-448, -528, -394, 430, 572,
	5490, 8288, 3350, 4027, 2114,
	-1173, 4162, -686, -761, -1264,
	2508, 959, -225, -2091,	// rgWeightHidden+1*19
 -2599,
	-2722, -800, -634, 26, 177,
	-1150, 933, 1221, 1764, 112,
	264, 2847, 317, 788, 460,
	3133, -1511, -508,	// rgWeightHidden+2*19
 363, -3731,
	-83, 1454, 51, -2340, 2049,
	-3503, -318, 1767, -285, 1363,
	-535, -880, 1783, 262, -275,
	540, 121,	// rgWeightHidden+3*19
 -2039, 4152, 5881,
	2994, -4703, 1713, 1657, 4205,
	972, -983, 4452, -839, 2089,
	-734, 1200, 442, 135, -499,
	-1390,	// rgWeightHidden+4*19
 -4495, 3142, 1603, 6589,
	-3935, 1469, -293, 2404, -444,
	-618, 6542, -1311, 694, -847,
	-174, 2004, 2336, 920, -987,
	// rgWeightHidden+5*19
	1570, -3065, -1683, -588, -3089,
	11, 2088, -771, 3734, 3088,
	-7386, 1678, -1124, 192, -80,
	908, 1627, -5474, -38,	// rgWeightHidden+6*19
 1954,
	7294, 10833, 1000, 2099, 2369,
	1242, 626, 454, 2572, -2882,
	421, -753, -98, -2647, -1421,
	-3539, 349, 604,	// rgWeightHidden+7*19
 896, -4607,
	-12399, -1664, 171, -51, 300,
	-710, 719, 2085, -1675, 115,
	-1096, -1275, -284, -1564, -2993,
	-415, 358};  // rgWeightHidden[8*19]

static const int rgBiasHidden[8] = {
	-4639, -1667, -512, 375, -1028,
	-1585, 2654, 1088
};  // rgBiasHidden[8]

// layer 2
static const int cOutput = 3;
static const int rgWeightOutput[3*8] = {
	// rgWeightOutput+0*8
	1335, -382, 1151, 397, 829,
	-2413, 356, 343,	// rgWeightOutput+1*8
 -979, 572,
	-1, 253, 642, -300, -766,
	-8,	// rgWeightOutput+2*8
 -1043, -379, -1402, -528,
	-968, 3093, 999, -290};  // rgWeightOutput[3*8]

static const int rgBiasOutput[3] = {
	-1597, -423, 264
};  // rgBiasOutput[3]



#include "math16.h"


static void ForwardFeedLayer(int cLayer0, int *rgLayer0, int cLayer1, unsigned short *rgLayer1, const int *rgWeight, const int *rgBias)
{
	int i, j;
	__int64 sum;
	__int64 iVal;
	int *pInput;

	for (i=cLayer1; i; i--)
	{
		sum = ((__int64)(*rgBias++))<< 16;
		pInput = rgLayer0;
		for (j=cLayer0; j; j--)
		{
			iVal = (__int64)(*rgWeight++) * (*pInput++);
			sum += iVal;
		}

		sum	=	(sum >> 8);

		sum	=	max (INT_MIN + 1, min(INT_MAX - 1, sum));
		
		j = Sigmoid16((int)sum);
		if (j > 0xFFFF)
			j = 0xFFFF;

		*rgLayer1++ = (unsigned short)j;
	}
}

static __int64 ForwardFeedLayerNoSig(int cLayer0, unsigned short *rgLayer0, int cLayer1, __int64 *rgLayer1,const int *rgWeight,const int *rgBias)
{
	int i, j;
	__int64 sum, Tot = 0;
	__int64 iVal;
	unsigned short *pInput;

	for (i=cLayer1; i; i--)
	{
		sum = ((__int64)(*rgBias++)) << 16;
		pInput = rgLayer0;
		for (j=cLayer0; j; j--)
		{
			iVal = (__int64)(*rgWeight++) * (*pInput++);
			sum	 += iVal;
			
		}

		sum	= (sum >> 8);

		*rgLayer1++ =	sum;
		Tot		+=	abs (sum);
	}

	return Tot;
}

void ForwardFeed	(	int				*rgFeat, 
						unsigned short	*rgHidden, 
						__int64			*rgOutput
					)
{

	ForwardFeedLayer	(	cInput, 
							rgFeat, 
							cHidden, 
							rgHidden, 
							rgWeightHidden,
							rgBiasHidden
						);

	ForwardFeedLayerNoSig	(	cHidden, 
								rgHidden, 
								cOutput, 
								rgOutput, 
								rgWeightOutput,
								rgBiasOutput
							);

}

int LineSegNN (int *pFeat)
{
	unsigned short	aHidden[50];
	__int64			aOutput[10];
	int				i, iBest	=	0;

	ForwardFeed (pFeat, aHidden, aOutput);

	for (i = 1; i < cOutput; i++)
	{
		if (aOutput[i]	> aOutput[iBest])
			iBest	=	i;
	}

	return iBest;
}


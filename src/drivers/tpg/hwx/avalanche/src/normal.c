// Normal.c
// James A. Pittman

// Table of probabilities from the normal distribution, with each entry representing
// the area under the curve of a one-sixteenth slice.  Floats should be multiplied
// by 16 and converted to an int to index into this table.  In other words the index
// represents x' (sometimes called the z score), bit shifted 4 to the left.
// x' (or z) is computed as (x - mean) / stddev

// Note that the table is folded, since it is symmetric.

// The probs in this table are exp(-((x*x)/2)) * (1/16) / sqrt(2*PI),
// but then converted to a log-prob using a scale of -2961.865623695891
// The x in this formula for aNormalTable[i] is i*(1/16) + (1/32).

#include <common.h>
#include "Normal.h"

#ifdef DPROB
#define PROBCONST(f,l) f
#else
#define PROBCONST(f,l) l
#endif

#define MAXZ 112
#define NORMTABLESHIFT 4

static const PROB aNormalTable[MAXZ+1] =
{PROBCONST(0.024922, 10935),
 PROBCONST(0.024825, 10946),
 PROBCONST(0.024631, 10969),
 PROBCONST(0.024344, 11004),
 PROBCONST(0.023967, 11050),
 PROBCONST(0.023503, 11108),
 PROBCONST(0.022959, 11178),
 PROBCONST(0.022340, 11259),
 PROBCONST(0.021652, 11351),
 PROBCONST(0.020904, 11455),
 PROBCONST(0.020104, 11571),
 PROBCONST(0.019258, 11698),
 PROBCONST(0.018376, 11837),
 PROBCONST(0.017466, 11988),
 PROBCONST(0.016537, 12150),
 PROBCONST(0.015596, 12323),
 PROBCONST(0.014651, 12508),

 PROBCONST(0.013709, 12705),
 PROBCONST(0.012779, 12913),
 PROBCONST(0.011865, 13133),
 PROBCONST(0.010973, 13364),
 PROBCONST(0.010109, 13607),
 PROBCONST(0.009276, 13862),
 PROBCONST(0.008479, 14128),
 PROBCONST(0.007720, 14406),
 PROBCONST(0.007002, 14695),
 PROBCONST(0.006326, 14996),
 PROBCONST(0.005693, 15308),
 PROBCONST(0.005103, 15632),
 PROBCONST(0.004556, 15968),
 PROBCONST(0.004052, 16315),
 PROBCONST(0.003590, 16673),
 PROBCONST(0.003168, 17044),

 PROBCONST(0.002785, 17425),
 PROBCONST(0.002439, 17819),
 PROBCONST(0.002127, 18224),
 PROBCONST(0.001848, 18640),
 PROBCONST(0.001599, 19068),
 PROBCONST(0.001379, 19508),
 PROBCONST(0.001184, 19959),
 PROBCONST(0.001013, 20422),
 PROBCONST(0.000863, 20896),
 PROBCONST(0.000732, 21382),
 PROBCONST(0.000619, 21880),
 PROBCONST(0.000521, 22389),
 PROBCONST(0.000437, 22909),
 PROBCONST(0.000365, 23442),
 PROBCONST(0.000304, 23985),
 PROBCONST(0.000252, 24541),

 PROBCONST(0.000208, 25108),
 PROBCONST(0.000171, 25686),
 PROBCONST(0.000140, 26276),
 PROBCONST(0.000115, 26878),
 PROBCONST(9.31E-05, 27491),
 PROBCONST(7.54E-05, 28116),
 PROBCONST(6.08E-05, 28752),
 PROBCONST(4.89E-05, 29400),
 PROBCONST(3.91E-05, 30060),
 PROBCONST(3.12E-05, 30731),
 PROBCONST(2.48E-05, 31413),
 PROBCONST(1.96E-05, 32107),
 PROBCONST(1.54E-05, 32813),
 PROBCONST(1.21E-05, 33531),
 PROBCONST(9.47E-06, 34259),
 PROBCONST(7.38E-06, 35000),

 PROBCONST(5.72E-06, 35752),
 PROBCONST(4.42E-06, 36516),
 PROBCONST(3.40E-06, 37291),
 PROBCONST(2.61E-06, 38077),
 PROBCONST(1.99E-06, 38876),
 PROBCONST(1.52E-06, 39686),
 PROBCONST(1.15E-06, 40507),
 PROBCONST(8.68E-07, 41340),
 PROBCONST(6.52E-07, 42185),
 PROBCONST(4.89E-07, 43041),
 PROBCONST(3.64E-07, 43909),
 PROBCONST(2.71E-07, 44788),
 PROBCONST(2.00E-07, 45679),
 PROBCONST(1.48E-07, 46581),
 PROBCONST(1.09E-07, 47495),
 PROBCONST(7.94E-08, 48421),

 PROBCONST(5.79E-08, 49358),
 PROBCONST(4.20E-08, 50307),
 PROBCONST(3.04E-08, 51267),
 PROBCONST(2.19E-08, 52239),
 PROBCONST(1.57E-08, 53222),
 PROBCONST(1.12E-08, 54217),
 PROBCONST(7.99E-09, 55224),
 PROBCONST(5.67E-09, 56242),
 PROBCONST(4.00E-09, 57272),
 PROBCONST(2.82E-09, 58313),
 PROBCONST(1.97E-09, 59366),
 PROBCONST(1.38E-09, 60430),
 PROBCONST(9.58E-10, 61506),
 PROBCONST(6.64E-10, 62594),
 PROBCONST(4.58E-10, 63693),
 PROBCONST(3.15E-10, 64804),

 PROBCONST(2.15E-10, 65926),
 PROBCONST(1.47E-10, 67060),
 PROBCONST(9.98E-11, 68205),
 PROBCONST(6.75E-11, 69362),
 PROBCONST(4.55E-11, 70531),
 PROBCONST(3.06E-11, 71711),
 PROBCONST(2.04E-11, 72903),
 PROBCONST(1.36E-11, 74106),
 PROBCONST(9.03E-12, 75321),
 PROBCONST(5.97E-12, 76547),
 PROBCONST(3.93E-12, 77785),
 PROBCONST(2.58E-12, 79035),
 PROBCONST(1.68E-12, 80296),
 PROBCONST(1.10E-12, 81568),
 PROBCONST(7.10E-13, 82853),
 PROBCONST(4.59E-13, 84148)};

// Converts a numerical value into a probability, given a particular
// normal distribution.  Returns the prob or log-prob.

PROB NormalProb(int x, int mean, int stddev)
{
	int z = (abs(x - mean) << NORMTABLESHIFT) / stddev;
	if (MAXZ < z)
		z = MAXZ;
	return aNormalTable[z];
}

PROB BestNormalProb()
{
	return aNormalTable[0];
}

PROB WorstNormalProb()
{
	return aNormalTable[MAXZ];
}
